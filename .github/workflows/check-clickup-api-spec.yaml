name: Check ClickUp API Specification Changes

# Run daily at 00:00 UTC
on:
  schedule:
    - cron: '0 0 * * *'
  # Allow manual triggering
  workflow_dispatch:
  # For testing and development
  push:
    branches:
      - "develop/ci-cd"
      - "**ci"
      - "ci**"

env:
  BASE_BRANCH: master

jobs:
  check-api-spec:
    name: Check API Specification Changes
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: 3.13    # NOTE: Caused by *PyO3's maximum supported version (3.13)*

      - name: Activate the uv virtual environment
        run: |
          uv venv
          . .venv/bin/activate

      - name: Install all the project dependencies
        run: uv sync --no-install-project --no-default-groups

      - name: Check API specification changes
        id: check-api-spec
        run: |
          uv run python scripts/ci/api_spec_checker.py --update --verbose
#          chmod +x scripts/ci/api_spec_checker.py

      - name: Create PR branch if changes detected
        if: ${{ failure() && steps.check-api-spec.conclusion == 'failure' }}
        run: |
          # Setup git
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a new branch with timestamp
          BRANCH_NAME="auto-update-clickup-api-spec-$(date +%Y%m%d-%H%M%S)"
          git switch ${{ env.BASE_BRANCH }}
          git checkout -b $BRANCH_NAME
          
          # Get current API version
          API_VERSION=$(jq -r '.info.version' docs/api_spec/openapi.json)
          echo "API_VERSION=$API_VERSION" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Commit changes
          git add docs/api_spec/openapi.json
          git commit -m "ðŸ”§ Update ClickUp API spec to version $API_VERSION"
          
          # Push changes
          git push origin $BRANCH_NAME

      - name: Process PR template
        if: ${{ failure() && steps.check-api-spec.conclusion == 'failure' }}
        run: |
          # Get current date
          CURRENT_DATE=$(date +"%Y-%m-%d")
          
          # Create a processed template
          mkdir -p /tmp
          cat .github/api-spec-pr-template.md | \
            sed "s/{{ version }}/${{ env.API_VERSION }}/g" | \
            sed "s/{{ date }}/$CURRENT_DATE/g" > /tmp/processed-pr-template.md
          
          echo "PR_TEMPLATE_PATH=/tmp/processed-pr-template.md" >> $GITHUB_ENV

      - name: Create Pull Request
        if: ${{ failure() && steps.check-api-spec.conclusion == 'failure' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ”§ Auto-update ClickUp API spec to version ${{ env.API_VERSION }}"
          title: "ðŸ”§ Auto-update ClickUp API spec to version ${{ env.API_VERSION }}"
          body-path: ${{ env.PR_TEMPLATE_PATH }}
          branch: ${{ env.BRANCH_NAME }}
          base: ${{ env.BASE_BRANCH }}
          labels: api, automated-pr
          draft: false
